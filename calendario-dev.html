<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendario Serie A DEV</title>
    <link rel="stylesheet" href="style-dev.css">
    <style>
        /* A simple loader style that will be used when fetching data */
        .loader {
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid #3498db;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <header>
        <h1>Calendario Serie A 2024/25 (Dev)</h1>
    </header>
    <main id="app-container">
        <nav id="matchday-navigation">
            <!-- Buttons for matchdays 1-4 will be generated by JS -->
        </nav>
        <section id="matches-grid">
            <!-- Match cards will be rendered here -->
        </section>
    </main>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const matchdayNav = document.getElementById('matchday-navigation');
            const matchesGrid = document.getElementById('matches-grid');
            let currentMatchday = 1;

            const setupNavigation = () => {
                for (let i = 1; i <= 4; i++) {
                    const button = document.createElement('button');
                    button.textContent = `Giornata ${i}`;
                    button.dataset.matchday = i;
                    if (i === currentMatchday) {
                        button.classList.add('active');
                    }
                    button.addEventListener('click', () => {
                        currentMatchday = i;
                        document.querySelectorAll('#matchday-navigation button').forEach(btn => btn.classList.remove('active'));
                        button.classList.add('active');
                        loadMatches(currentMatchday);
                    });
                    matchdayNav.appendChild(button);
                }
            };

            const loadMatches = async (matchday) => {
                matchesGrid.innerHTML = '<div class="loader"></div>';
                try {
                    const response = await fetch(`/api/getMatchesByMatchday?matchday=${matchday}`);
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || 'Failed to fetch matches.');
                    }
                    const matches = await response.json();
                    renderMatches(matches);
                } catch (error) {
                    console.error(`Error loading matches for matchday ${matchday}:`, error);
                    matchesGrid.innerHTML = `<p style="text-align: center; color: red;">Error: ${error.message}</p>`;
                }
            };

            const renderMatches = (matches) => {
                matchesGrid.innerHTML = '';
                if (!matches || matches.length === 0) {
                    matchesGrid.innerHTML = '<p style="text-align: center;">Nessuna partita trovata per questa giornata.</p>';
                    return;
                }

                matches.forEach(match => {
                    const card = document.createElement('div');
                    card.className = 'match-card';
                    card.dataset.matchId = match.id;

                    const scoreOrTime = match.status === 'FINISHED'
                        ? `${match.score.fullTime.home} - ${match.score.fullTime.away}`
                        : new Date(match.utcDate).toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' });

                    card.innerHTML = `
                        <div class="match-summary">
                            <div class="team">
                                <img src="${match.homeTeam.crest}" alt="${match.homeTeam.name}" class="team-crest">
                                <span class="team-name">${match.homeTeam.shortName || match.homeTeam.name}</span>
                            </div>
                            <div class="match-info">${scoreOrTime}</div>
                            <div class="team">
                                <img src="${match.awayTeam.crest}" alt="${match.awayTeam.name}" class="team-crest">
                                <span class="team-name">${match.awayTeam.shortName || match.awayTeam.name}</span>
                            </div>
                        </div>
                        <div class="match-details-content"></div>
                    `;
                    card.addEventListener('click', () => toggleDetails(card, match.id));
                    matchesGrid.appendChild(card);
                });
            };

            const toggleDetails = async (card, matchId) => {
                const detailsContainer = card.querySelector('.match-details-content');
                const isVisible = detailsContainer.classList.contains('visible');

                if (isVisible) {
                    detailsContainer.classList.remove('visible');
                } else {
                    // Close any other open cards
                    document.querySelectorAll('.match-details-content.visible').forEach(openDetail => {
                        openDetail.classList.remove('visible');
                    });

                    detailsContainer.innerHTML = '<div class="loader"></div>';
                    detailsContainer.classList.add('visible');

                    try {
                        const response = await fetch(`/api/getMatchDetails?matchId=${matchId}`);
                        if (!response.ok) {
                             const errorData = await response.json();
                            throw new Error(errorData.error || 'Failed to fetch details.');
                        }
                        const details = await response.json();
                        renderDetails(detailsContainer, details);
                    } catch (error) {
                         console.error(`Error loading details for matchId ${matchId}:`, error);
                        detailsContainer.innerHTML = `<p style="color: red;">Error: ${error.message}</p>`;
                    }
                }
            };

            const renderDetails = (container, details) => {
                const { goals, bookings, substitutions, homeTeam, awayTeam } = details;

                const renderPlayerList = (players) => players.map(p => `<li>${p.name}</li>`).join('');
                const renderSubstitutions = (team) => {
                    const teamSubs = substitutions.filter(s => s.team.id === team.id);
                    if (teamSubs.length === 0) return '<li>Nessuna</li>';
                    return teamSubs.map(s => `<li>${s.minute}' <strong>In:</strong> ${s.playerIn.name} / <strong>Out:</strong> ${s.playerOut.name}</li>`).join('');
                };

                container.innerHTML = `
                    <div class="details-section">
                        <h4>Goals</h4>
                        <ul>${goals.length ? goals.map(g => `<li>${g.minute}' ${g.scorer.name} (${g.team.name})</li>`).join('') : '<li>Nessun goal</li>'}</ul>
                    </div>
                    <div class="details-section">
                        <h4>Cartellini</h4>
                        <ul>${bookings.length ? bookings.map(b => `<li>${b.minute}' ${b.player.name} (${b.card})</li>`).join('') : '<li>Nessun cartellino</li>'}</ul>
                    </div>
                    <div class="details-section">
                        <h4>Sostituzioni (${homeTeam.name})</h4>
                        <ul>${renderSubstitutions(homeTeam)}</ul>
                    </div>
                    <div class="details-section">
                        <h4>Sostituzioni (${awayTeam.name})</h4>
                        <ul>${renderSubstitutions(awayTeam)}</ul>
                    </div>
                    <div class="details-section">
                        <h4>Formazione (${homeTeam.name})</h4>
                        <ul>${renderPlayerList(homeTeam.lineup)}</ul>
                        <h5>Panchina</h5>
                        <ul>${renderPlayerList(homeTeam.bench)}</ul>
                    </div>
                    <div class="details-section">
                        <h4>Formazione (${awayTeam.name})</h4>
                        <ul>${renderPlayerList(awayTeam.lineup)}</ul>
                        <h5>Panchina</h5>
                        <ul>${renderPlayerList(awayTeam.bench)}</ul>
                    </div>
                `;
            };

            // Initial Load
            setupNavigation();
            loadMatches(currentMatchday);
        });
    </script>
</body>
</html>
